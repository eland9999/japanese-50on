<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>五十音世界 | Kana Worldclass</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+JP:wght@700;900&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --brand-main: #2266dd;
      --brand-sub: #6cd9e4;
      --brand-accent: #ffc400;
      --brand-bg: #f8faff;
      --brand-panel: #fff;
      --brand-card: #f8fbff;
      --brand-shadow: 0 2px 13px 0 #1a28481d, 0 2px 10px #53c3f329;
      --brand-radius: 2.2rem;
      --brand-radius-sm: 1rem;
      --brand-gray: #24324b;
      --brand-gray-soft: #8ca1be;
      --brand-error: #ea5163;
      --brand-success: #22b77d;
      --brand-correct-bg: #e8fcf4;
      --brand-wrong-bg: #fff0f4;
      --focus: #ffd65e;
      --gradient-main: linear-gradient(95deg, #6cd9e4 6%, #2266dd 96%);
      --gradient-gold: linear-gradient(92deg, #ffc233 60%, #ffd96c 100%);
      --header-gradient: linear-gradient(91deg, #2266dd 75%, #ffc233 100%);
      --card-glow: 0 0 0.6rem 0.06rem #53c3f3a0;
      --input-glow: 0 1.7px 7px #6cd9e44c;
      /* 暗色 */
      --dark-bg: #131b2c;
      --dark-panel: #212a3c;
      --dark-card: #1a2437;
      --dark-shadow: 0 6px 22px #11202a70;
      --dark-main: #70b3ff;
      --dark-accent: #ffe061;
      --dark-correct-bg: #133d2e;
      --dark-wrong-bg: #392127;
      --dark-gray: #d7e7fa;
      --dark-gray-soft: #9cc5e9;
      --dark-error: #fa7b96;
      --dark-success: #60d6a6;
    }
    html, body {
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      background: var(--brand-bg);
      color: var(--brand-gray);
      margin: 0;
      padding: 0;
      min-height:100vh;
      transition: background .32s, color .26s;
    }
    html.dark, html.dark body {
      background: var(--dark-bg);
      color: var(--dark-gray);
    }
    header {
      text-align:center;
      padding: 2.7rem 0 1.2rem 0;
      background: transparent;
    }
    header h1 {
      font-size:2.9em;
      font-weight:900;
      letter-spacing:2.5px;
      margin-bottom: 10px;
      line-height: 1.06;
      background: var(--header-gradient);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
    }
    html.dark header h1 {
      background: linear-gradient(90deg, #70b3ff 75%, #ffe061 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .subtitle {
      color: var(--brand-gray-soft);
      font-size: 1.16em;
      letter-spacing: 2.5px;
      margin: 10px 0 28px 0;
      font-weight: 700; opacity: .87;
    }
    .nav-row {
      display: flex;
      justify-content: center;
      gap: 1.3rem;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .nav-row .nav-link {
      color: var(--brand-main);
      text-decoration: none;
      font-weight: 800;
      font-size: 1.13em;
      background: #e8f0fc;
      border-radius: var(--brand-radius-sm);
      padding: .67em 1.4em;
      transition: background .15s, color .15s, box-shadow .14s, transform .11s;
      box-shadow: 0 1.5px 7px #74b8ff19;
      border: 2.5px solid transparent;
      margin-bottom: 6px;
    }
    .nav-row .nav-link.active {
      background: var(--gradient-main);
      color: #fff;
      box-shadow: 0 3px 13px #53c3f349;
    }
    .nav-row .nav-link:focus {
      border:2.5px solid var(--brand-accent);
      outline: none;
    }
    html.dark .nav-row .nav-link {background: var(--dark-card);color: var(--dark-main);}
    html.dark .nav-row .nav-link.active {background: var(--gradient-main);color:#222;}
    .sub-nav-row {
      display: flex;
      justify-content: center;
      gap: 1.1rem;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    .sub-nav-row .sub-link {
      color: var(--brand-main);
      background: #eaf6fe;
      border-radius: .9rem;
      padding: .55em 1.12em;
      font-weight: 700;
      font-size: 1.09em;
      border: 2.2px solid transparent;
      margin-bottom: 6px;
      transition: background .14s, color .14s, box-shadow .13s, transform .12s;
      box-shadow: 0 1.2px 6px #43b8ff13;
    }
    .sub-nav-row .sub-link.active {
      background: var(--gradient-gold);
      color: #37466c;
      box-shadow: 0 2.8px 11px #ffdc7548;
    }
    .sub-nav-row .sub-link:focus {border:2.2px solid var(--brand-main);}
    html.dark .sub-nav-row .sub-link {background: var(--dark-card);color: var(--dark-main);}
    html.dark .sub-nav-row .sub-link.active {background: var(--gradient-gold);color:#1d263b;}
    .theme-switch {
      position:fixed; right:32px; top:30px; z-index:25;
    }
    .theme-btn {
      background:var(--brand-card); border-radius:50%; border:none;
      box-shadow:0 1.5px 10px #74b8ff20; font-size:1.6em; padding:13px 16px; cursor:pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background .18s, box-shadow .18s, transform .13s;
    }
    .theme-btn.switching {transform: rotate(180deg) scale(1.10);}
    .theme-btn:hover {background:#e3f2fd;}
    html.dark .theme-btn {background: var(--dark-panel);}
    .main-panel-wrap {
      width: 100%;
      max-width: 1050px;
      margin: 0 auto 38px auto;
      background: var(--brand-panel);
      border-radius: var(--brand-radius);
      box-shadow: var(--brand-shadow);
      padding: 2.5rem 3rem 2.3rem 3rem;
      transition: background .23s, box-shadow .23s;
      min-height: 380px;
      overflow-x: auto;
    }
    html.dark .main-panel-wrap {
      background: var(--dark-panel);
      box-shadow: var(--dark-shadow);
    }
    /* 卡片區域 */
    .jp-card-table{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:27px 0;
      margin-bottom:39px;
      width:100%;
    }
    .jp-card-row{
      display:flex;
      flex-direction:row;
      justify-content:center;
      gap:0 22px;
      flex-wrap:nowrap;
      width: 100%;
    }
    .jp-card{
      background: var(--brand-card);
      border-radius:22px;
      box-shadow: var(--card-glow), var(--brand-shadow);
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:38px 18px 24px 18px;
      min-width:142px;
      min-height:168px;
      margin:0 11px;
      transition: box-shadow .18s, background .23s, border .13s, transform .14s;
      border:2.1px solid #e6e8f1;
      position:relative;
      overflow:hidden;
      outline:none;
      user-select:none;
      animation: fadeInUp .52s cubic-bezier(.18,.78,.37,1.11);
    }
    .jp-card.empty{background:transparent;box-shadow:none;border:none;}
    .jp-card:hover, .jp-card:focus {
      box-shadow: 0 13px 26px #b5e2ff35, 0 2px 11px #53c3f349;
      background:linear-gradient(109deg, #f2f7ff 80%, #deeeff 100%);
      border:2.1px solid var(--brand-main);
      z-index:2; outline: none; transform:translateY(-3px) scale(1.015);
    }
    html.dark .jp-card{
      background: var(--dark-card); box-shadow: var(--dark-shadow); border:2.1px solid #26314b;
    }
    html.dark .jp-card:hover, html.dark .jp-card:focus{
      background:linear-gradient(118deg, #24314b 78%, #15345e 100%);
      border:2.1px solid var(--dark-main);
      box-shadow: 0 14px 29px #11409445, 0 2.5px 9px #53c3f349;
    }
    .jp-kana{
      font-size:2.45em; margin-bottom:8px; line-height:1.11;
      font-weight:900; letter-spacing:2.3px; color:var(--brand-main); text-shadow: 0 4px 14px #b3e0ff31;
      transition: color .14s;
    }
    html.dark .jp-kana{color: var(--dark-main);}
    .roman{
      font-size:1.18em; color:var(--brand-accent); margin-bottom:14px; letter-spacing:1.5px;
      font-family:'Inter',sans-serif; font-weight:800; opacity:.89; transition: color .15s;
    }
    html.dark .roman{color: var(--dark-accent);}
    .jp-katakana{font-size:1em;color:#56aaff;font-weight:700;margin-left:7px;letter-spacing: .5px;opacity:.86;}
    html.dark .jp-katakana{color: #ffe49c;}
    .example-word{font-weight:700;color:#b7980a;}
    .example{
      font-size:1.04em;color:#818fa2;text-align:center;min-height:25px;margin-bottom:2px;margin-top:2px;line-height:1.29;opacity:.78;transition: color .11s;
    }
    html.dark .example{color:#e9ce9e;}
    /* Yoon拗音區域自適應設計 */
    .yoon-flex-wrap{
      display: flex;
      flex-wrap: wrap;
      gap: 14px 9px;
      justify-content: center;
      width: 100%;
      max-width: 1140px;
    }
    @media (max-width: 1100px){
      .yoon-flex-wrap{max-width: 900px;}
      .jp-card{min-width:110px;padding:28px 8px 14px 8px;}
    }
    @media (max-width: 900px){
      .yoon-flex-wrap{max-width: 660px;}
      .jp-card{min-width:94px;padding:17px 3vw 11px 3vw;}
      .jp-kana{font-size:1.3em;}
    }
    @media (max-width: 700px){
      .main-panel-wrap{padding: 1rem 2vw;}
      .yoon-flex-wrap{max-width: 99vw;}
    }
    @media (max-width: 500px){
      .jp-card{min-width:62px;padding:11px 2vw 8px 2vw;}
      .jp-kana{font-size:.92em;}
      .yoon-flex-wrap{gap:6px 2px;}
    }
    .scroll-hint{
      display:none;
      color: #ffd45a;
      text-align: center;
      font-size: .99em;
      margin-bottom: 5px;
      letter-spacing: 1.2px;
      font-weight: 600;
    }
    @media (max-width: 700px){
      .scroll-hint{display:block;}
    }
    /* Quiz / Exam */
    .jp-quiz-table{display:flex;flex-direction:column;align-items:center;gap:19px 0;margin-bottom:24px;}
    .jp-quiz-row{display:flex;flex-direction:row;justify-content:center;gap:0 9px;}
    .quiz-cell, .quiz-cell-ani{
      background:var(--brand-card); border-radius:14px; box-shadow: var(--brand-shadow);
      display:flex;flex-direction:column;align-items:center;
      padding:19px 10px 12px 10px;min-width:91px;min-height:82px;
      transition: background .13s, box-shadow .16s;
      margin:0 3px; outline:none; border:1.7px solid #dbe8f5; user-select:none;
      animation: fadeInUp .53s cubic-bezier(.19,.82,.39,1.14);
    }
    .quiz-cell-ani.ani-correct{animation:flashGreen .29s;}
    .quiz-cell-ani.ani-wrong{animation:shakeRed .34s;}
    @keyframes flashGreen { 0%{box-shadow:0 0 0 #82ffb1;} 40%{box-shadow:0 0 12px #8fe59a;} 70%{box-shadow:0 0 5px #22b77d;} 100%{box-shadow:0 2px 7px #0002;} }
    @keyframes shakeRed { 0%{transform:translateX(0);} 22%{transform:translateX(-6px);} 35%{transform:translateX(5px);} 55%{transform:translateX(-3px);} 65%{transform:translateX(2px);} 100%{transform:translateX(0);} }
    .quiz-cell:focus,.quiz-cell-ani:focus {border:2px solid var(--focus);}
    .quiz-cell-kana{font-size:1.38em;margin-bottom:9px;}
    .quiz-cell-input, .quiz-a{
      width:56px;text-align:center;font-size:1em;padding:4px 5px;margin-bottom:7px;
      border: 1.2px solid #c2e6ff; border-radius:8px;background:var(--brand-bg);
      font-family:inherit;transition:background .11s, box-shadow .18s;
      outline:none; box-shadow: var(--input-glow);
    }
    .quiz-a:focus, .quiz-cell-input:focus{outline:2.1px solid var(--brand-main);}
    /* 明亮/暗色 quiz input 顏色 */
    html.dark .quiz-cell, html.dark .quiz-cell-ani{
      background:var(--dark-card);
      border:1.7px solid #374c67;
      box-shadow: var(--dark-shadow);
    }
    html.dark .quiz-cell-input, html.dark .quiz-a{
      background: #20314e;
      color: var(--dark-main);
      border: 1.2px solid #4e85bd;
      box-shadow: 0 2px 12px #20406422;
    }
    .quiz-cell-input.correct, .quiz-a.correct {background: var(--brand-correct-bg);}
    .quiz-cell-input.incorrect, .quiz-a.incorrect {background: var(--brand-wrong-bg);}
    html.dark .quiz-cell-input.correct, html.dark .quiz-a.correct {background: var(--dark-correct-bg);color:var(--dark-success);}
    html.dark .quiz-cell-input.incorrect, html.dark .quiz-a.incorrect {background: var(--dark-wrong-bg);color:var(--dark-error);}
    .feedback{font-size:.98em;font-weight:700;margin-top:2px;min-height:1.1em;}
    .correct{color:var(--brand-success);}
    .incorrect{color:var(--brand-error);}
    html.dark .correct{color:var(--dark-success);}
    html.dark .incorrect{color:var(--dark-error);}
    .quiz-title{
      text-align:center;font-size:1.19em;font-weight:900;color:var(--brand-main);margin-bottom:13px;letter-spacing:1.9px;
      text-shadow: 0 2px 10px #b6d4ff35;
    }
    html.dark .quiz-title{color:var(--dark-main);}
    .quiz-no{font-weight:700;font-size:1em;color:#ffc233;margin-bottom:1px;}
    .ans-ok{color:#22b77d;margin-left:4px;font-size:1.16em;font-weight:900;display:inline;}
    .ans-wrong{color:var(--brand-error);margin-left:5px;font-size:.97em;font-weight:900;display:inline;}
    html.dark .ans-ok{color:var(--dark-success);}
    html.dark .ans-wrong{color:var(--dark-error);}
    .score-box{
      text-align:center;margin:13px auto 0 auto;padding:13px 0 8px 0;
      font-size:1.12em;color:#fff;background:linear-gradient(92deg, var(--brand-main) 75%, var(--brand-accent) 100%);
      border-radius:13px;width:97%;max-width:340px;box-shadow:0 2px 9px #2266dd50;position:relative;
      font-weight: 700; transition: background .19s;
      animation: fadeInUp .38s cubic-bezier(.19,.82,.39,1.14);
    }
    html.dark .score-box{background:linear-gradient(94deg, #283b68 78%, #ffc233 100%);}
    .progress-ani {height:13px;width:86%;margin:13px auto 0 auto;background:#e5f3ff;border-radius:9px;overflow:hidden;}
    .progress-bar {height:100%;background:linear-gradient(90deg,#82d9ff 10%,#ffd85d 60%,#22b77d 99%);transition:width 0.44s cubic-bezier(.75,1.8,.37,.99);}
    .score-float{font-weight:800;font-size:1.18em;margin-top:8px;animation:bounceIn .71s;}
    @keyframes bounceIn { 0%{transform:scale(.7) translateY(-28px);} 55%{transform:scale(1.11) translateY(8px);} 83%{transform:scale(.93);} 100%{transform:scale(1);} }
    @keyframes fadeInUp {0%{opacity:0;transform:translateY(25px);}100%{opacity:1;transform:translateY(0);}}
    /* Footer */
    .jp-footer{
      background: #f7faff; color: #889bb2;
      padding: 18px 0 15px 0; text-align: center; font-size: 1.13em;
      letter-spacing: 1.5px; margin-top: 40px;
      border-top: 3px solid #d2e8ff33; opacity: 1; border-radius: 0 0 2.2rem 2.2rem;
      box-shadow: 0 -2px 16px #b7dfff53;
      font-family: 'Noto Sans JP', 'Inter', sans-serif;
      font-weight: 700; width:100vw; max-width:100vw;
    }
    .jp-footer-brand{
      font-weight: bold; color: var(--brand-main);
      letter-spacing: 2.2px; margin-left: 9px; font-size: 1.13em;
      font-family: 'Noto Sans JP', 'Inter', sans-serif;
    }
    html.dark .jp-footer{background: #1b2538;color:#b7cff7;}
    html.dark .jp-footer-brand{color: var(--dark-main);}
    .clearwrong-btn{
      background: #ffe284; color: #1a1b24; border:none; border-radius:8px;
      font-weight:700; padding:7px 18px; cursor:pointer; font-size:1.05em; margin-left:16px;
      box-shadow:0 1.7px 7px #ffd46261; transition: background .13s;
    }
    .clearwrong-btn:active {background:#ffe672;}
    html.dark .clearwrong-btn{background:#27272f;color:#ffe061;}
    @media (max-width:1000px){
      .main-panel-wrap{padding: 1.1rem 1.6vw 1.1rem 1.6vw;}
    }
    @media (max-width:630px){
      header{padding:7vw 0 2vw;}
      .main-panel-wrap{box-shadow:none;border-radius:0;padding:2vw 2vw;}
      .nav-row, .sub-nav-row{gap:6px;}
      .jp-card{min-width:75px;font-size:.97em;padding: 4vw 1vw 2vw 1vw;}
      .jp-card-row,.jp-quiz-row{gap:0;}
      .jp-footer{border-radius:0;}
    }
  </style>
</head>
<body>
  <div class="theme-switch">
    <button class="theme-btn" id="themeBtn" title="切換主題" aria-label="切換主題">
      <span id="themeIcon">🌗</span>
    </button>
  </div>
  <header>
    <h1>Kana Worldclass 五十音</h1>
    <div class="subtitle">Japanese Kana | 五十音學習・全球級體驗</div>
    <nav class="nav-row" id="modeControls">
      <a href="#" data-mode="hiragana" class="nav-link active">平假名 Hiragana</a>
      <a href="#" data-mode="katakana" class="nav-link">片假名 Katakana</a>
      <a href="#" data-mode="dakuten_hira" class="nav-link">濁音(平) Dakuten-Hira</a>
      <a href="#" data-mode="dakuten_kata" class="nav-link">濁音(片) Dakuten-Kata</a>
      <a href="#" data-mode="handaku_hira" class="nav-link">半濁音(平) Handaku-Hira</a>
      <a href="#" data-mode="handaku_kata" class="nav-link">半濁音(片) Handaku-Kata</a>
      <a href="#" data-mode="yoon" class="nav-link">拗音 Yoon</a>
    </nav>
    <nav class="sub-nav-row" id="subControls">
      <a href="#" data-type="review" class="sub-link active">複習卡片 / Review</a>
      <a href="#" data-type="quiz" class="sub-link">隨機練習 / Practice</a>
      <a href="#" data-type="paper" class="sub-link">測驗考卷 / Exam</a>
      <a href="#" data-type="wrong" class="sub-link">錯題複習 / Mistakes</a>
      <button id="clearWrongBtn" class="clearwrong-btn">清空錯題 Clear</button>
    </nav>
    <div class="scroll-hint" id="scrollHintYoon" style="display:none;">（拗音卡片可左右滑動，或用手指滑動）</div>
  </header>
  <div class="main-panel-wrap">
    <div id="mainPanel"></div>
  </div>
  <footer class="jp-footer">
    © 2025 <span class="jp-footer-brand">KanaWorldclass</span> | Designed for learners, by learners.
  </footer>
  <script>
    // ======= 五十音題庫資料 =======
    const HIRAGANA = [
      ['あ','a'],['い','i'],['う','u'],['え','e'],['お','o'],
      ['か','ka'],['き','ki'],['く','ku'],['け','ke'],['こ','ko'],
      ['さ','sa'],['し','shi'],['す','su'],['せ','se'],['そ','so'],
      ['た','ta'],['ち','chi'],['つ','tsu'],['て','te'],['と','to'],
      ['な','na'],['に','ni'],['ぬ','nu'],['ね','ne'],['の','no'],
      ['は','ha'],['ひ','hi'],['ふ','fu'],['へ','he'],['ほ','ho'],
      ['ま','ma'],['み','mi'],['む','mu'],['め','me'],['も','mo'],
      ['や','ya'],['',''],['ゆ','yu'],['',''],['よ','yo'],
      ['ら','ra'],['り','ri'],['る','ru'],['れ','re'],['ろ','ro'],
      ['わ','wa'],['',''],['',''],['',''],['を','o'],
      ['ん','n']
    ];
    const KATAKANA = [
      ['ア','a'],['イ','i'],['ウ','u'],['エ','e'],['オ','o'],
      ['カ','ka'],['キ','ki'],['ク','ku'],['ケ','ke'],['コ','ko'],
      ['サ','sa'],['シ','shi'],['ス','su'],['セ','se'],['ソ','so'],
      ['タ','ta'],['チ','chi'],['ツ','tsu'],['テ','te'],['ト','to'],
      ['ナ','na'],['ニ','ni'],['ヌ','nu'],['ネ','ne'],['ノ','no'],
      ['ハ','ha'],['ヒ','hi'],['フ','fu'],['ヘ','he'],['ホ','ho'],
      ['マ','ma'],['ミ','mi'],['ム','mu'],['メ','me'],['モ','mo'],
      ['ヤ','ya'],['',''],['ユ','yu'],['',''],['ヨ','yo'],
      ['ラ','ra'],['リ','ri'],['ル','ru'],['レ','re'],['ロ','ro'],
      ['ワ','wa'],['',''],['',''],['',''],['ヲ','o'],
      ['ン','n']
    ];
    const DAKUTEN_HIRA = [
      ['が','ga'],['ぎ','gi'],['ぐ','gu'],['げ','ge'],['ご','go'],
      ['ざ','za'],['じ','ji'],['ず','zu'],['ぜ','ze'],['ぞ','zo'],
      ['だ','da'],['ぢ','ji'],['づ','zu'],['で','de'],['ど','do'],
      ['ば','ba'],['び','bi'],['ぶ','bu'],['べ','be'],['ぼ','bo']
    ];
    const DAKUTEN_KATA = [
      ['ガ','ga'],['ギ','gi'],['グ','gu'],['ゲ','ge'],['ゴ','go'],
      ['ザ','za'],['ジ','ji'],['ズ','zu'],['ゼ','ze'],['ゾ','zo'],
      ['ダ','da'],['ヂ','ji'],['ヅ','zu'],['デ','de'],['ド','do'],
      ['バ','ba'],['ビ','bi'],['ブ','bu'],['ベ','be'],['ボ','bo']
    ];
    const HANDAKU_HIRA = [
      ['ぱ','pa'],['ぴ','pi'],['ぷ','pu'],['ぺ','pe'],['ぽ','po']
    ];
    const HANDAKU_KATA = [
      ['パ','pa'],['ピ','pi'],['プ','pu'],['ペ','pe'],['ポ','po']
    ];
    const YOON = [
      ['きゃ','キャ','kya'],['きゅ','キュ','kyu'],['きょ','キョ','kyo'],
      ['しゃ','シャ','sha'],['しゅ','シュ','shu'],['しょ','ショ','sho'],
      ['ちゃ','チャ','cha'],['ちゅ','チュ','chu'],['ちょ','チョ','cho'],
      ['にゃ','ニャ','nya'],['にゅ','ニュ','nyu'],['にょ','ニョ','nyo'],
      ['ひゃ','ヒャ','hya'],['ひゅ','ヒュ','hyu'],['ひょ','ヒョ','hyo'],
      ['みゃ','ミャ','mya'],['みゅ','ミュ','myu'],['みょ','ミョ','myo'],
      ['りゃ','リャ','rya'],['りゅ','リュ','ryu'],['りょ','リョ','ryo'],
      ['ぎゃ','ギャ','gya'],['ぎゅ','ギュ','gyu'],['ぎょ','ギョ','gyo'],
      ['じゃ','ジャ','ja'],['じゅ','ジュ','ju'],['じょ','ジョ','jo'],
      ['ぢゃ','ヂャ','ja'],['ぢゅ','ヂュ','ju'],['ぢょ','ヂョ','jo'],
      ['びゃ','ビャ','bya'],['びゅ','ビュ','byu'],['びょ','ビョ','byo'],
      ['ぴゃ','ピャ','pya'],['ぴゅ','ピュ','pyu'],['ぴょ','ピョ','pyo']
    ];
    const WORDS = {};
    function shuffle(arr){let a=arr.slice();for(let i=a.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
    function sample(arr,n){return shuffle(arr.filter(x=>x[0])).slice(0,n);}
    let wrongSet = new Set();
    let currMode = 'hiragana', currType = 'review';
    const controls = document.getElementById('modeControls');
    controls.onclick = function(e){
      if(e.target.matches('.nav-link')){
        for(let link of controls.children) link.classList.remove('active');
        e.target.classList.add('active');
        currMode = e.target.getAttribute('data-mode');
        updateView();
        e.preventDefault();
      }
    };
    const subControls = document.getElementById('subControls');
    subControls.onclick = function(e){
      if(e.target.matches('.sub-link')){
        for(let link of subControls.querySelectorAll('.sub-link')) link.classList.remove('active');
        e.target.classList.add('active');
        currType = e.target.getAttribute('data-type');
        updateView();
        e.preventDefault();
      }
    };
    // ====== 卡片 ======
    function renderCards(mode) {
      let html = '';
      let data = [];
      if(mode==='hiragana') data = HIRAGANA;
      else if(mode==='katakana') data = KATAKANA;
      else if(mode==='dakuten_hira') data = DAKUTEN_HIRA;
      else if(mode==='dakuten_kata') data = DAKUTEN_KATA;
      else if(mode==='handaku_hira') data = HANDAKU_HIRA;
      else if(mode==='handaku_kata') data = HANDAKU_KATA;
      if(mode !== 'yoon'){
        html += `<div class="jp-card-table">`;
        for(let i=0; i<data.length; i+=5){
          html += `<div class="jp-card-row">`;
          for(let j=0; j<5; j++){
            let idx = i+j;
            if(idx < data.length){
              let [kana, roma] = data[idx];
              if(kana){
                let ex = WORDS[kana]||['-','-',''];
                html += `<div class="jp-card" tabindex="0">
                  <div class="jp-kana">${kana}</div>
                  <div class="roman">${roma}</div>
                  <div class="example"><span class="example-word">${ex[0]}</span>（${ex[1]}）<br>${ex[2]}</div>
                </div>`;
              }else{
                html += `<div class="jp-card empty"></div>`;
              }
            }
          }
          html += `</div>`;
        }
        html += `</div>`;
        document.getElementById('scrollHintYoon').style.display = "none";
      } else {
        // 拗音自適應分行，橫向溢出自動wrap
        html = `<div class="yoon-flex-wrap">`;
        for(let [hiragana, katakana, roma] of YOON){
          let ex = WORDS[hiragana]||['-','-',''];
          html += `<div class="jp-card" tabindex="0" style="margin-bottom:8px;">
            <div class="jp-kana">${hiragana}<span class="jp-katakana">${katakana}</span></div>
            <div class="roman">${roma}</div>
            <div class="example"><span class="example-word">${ex[0]}</span>（${ex[1]}）<br>${ex[2]}</div>
          </div>`;
        }
        html += `</div>`;
        document.getElementById('scrollHintYoon').style.display = "";
      }
      document.getElementById('mainPanel').innerHTML = html;
      let cards = document.querySelectorAll('.jp-card');
      cards.forEach(card=>{
        card.addEventListener('keydown',e=>{
          let idx=[...cards].indexOf(card);
          if(e.key==='ArrowRight'&&cards[idx+1]){cards[idx+1].focus();}
          if(e.key==='ArrowLeft'&&cards[idx-1]){cards[idx-1].focus();}
          if(e.key==='ArrowDown'&&cards[idx+5]){cards[idx+5].focus();}
          if(e.key==='ArrowUp'&&cards[idx-5]){cards[idx-5].focus();}
        });
      });
    }
    // ====== 練習/錯題複習 ======
    function renderQuiz(mode, onlyWrong){
      let html = '', data = [], isYoon = false;
      if(mode==='hiragana') data = HIRAGANA;
      else if(mode==='katakana') data = KATAKANA;
      else if(mode==='dakuten_hira') data = DAKUTEN_HIRA;
      else if(mode==='dakuten_kata') data = DAKUTEN_KATA;
      else if(mode==='handaku_hira') data = HANDAKU_HIRA;
      else if(mode==='handaku_kata') data = HANDAKU_KATA;
      else if(mode==='yoon') isYoon = true;
      html += `<div class="quiz-title">${onlyWrong?'錯題複習 / Mistakes':'隨機練習 / Practice'}（${{
        'hiragana':'平假名','katakana':'片假名','dakuten_hira':'濁音（平）','dakuten_kata':'濁音（片）','handaku_hira':'半濁音（平）','handaku_kata':'半濁音（片）','yoon':'拗音'
      }[mode]||''}）</div>`;
      if(!isYoon){
        let pool = onlyWrong
          ? data.filter(x => wrongSet.has(x[0]))
          : data.filter(x=>x[0]);
        let quiz = pool.length>0 ? sample(pool, Math.min(10, pool.length)) : [];
        html += quiz.length ? `<div class="jp-quiz-table">` : `<div style="color:var(--brand-error);font-weight:700;">目前無錯題！</div>`;
        for(let i=0; i<quiz.length; i+=5){
          html += `<div class="jp-quiz-row">`;
          for(let j=0;j<5;j++){
            let idx = i+j;
            if(idx < quiz.length){
              let [kana, roma] = quiz[idx];
              html += `<div class="quiz-cell quiz-cell-ani" tabindex="0">
                <div class="quiz-cell-kana">${kana}</div>
                <input class="quiz-cell-input" data-answer="${roma}" autocomplete="off">
                <div class="feedback"></div>
              </div>`;
            }
          }
          html += `</div>`;
        }
        html += quiz.length ? `</div>` : '';
      } else {
        let all = [];
        for(let [hiragana, katakana, roma] of YOON){
          if(onlyWrong && !wrongSet.has(hiragana)) continue;
          all.push([hiragana, katakana, roma]);
        }
        let quiz = all.length>0 ? sample(all, Math.min(10, all.length)) : [];
        html += quiz.length ? `<div class="jp-quiz-table">` : `<div style="color:var(--brand-error);font-weight:700;">目前無錯題！</div>`;
        for(let i=0; i<quiz.length; i+=5){
          html += `<div class="jp-quiz-row">`;
          for(let j=0;j<5;j++){
            let idx = i+j;
            if(idx < quiz.length){
              let [hiragana, katakana, roma] = quiz[idx];
              html += `<div class="quiz-cell quiz-cell-ani" tabindex="0">
                <div class="quiz-cell-kana">${hiragana}<span class="jp-katakana">${katakana}</span></div>
                <input class="quiz-cell-input" data-answer="${roma}" autocomplete="off">
                <div class="feedback"></div>
              </div>`;
            }
          }
          html += `</div>`;
        }
        html += quiz.length ? `</div>` : '';
      }
      document.getElementById('mainPanel').innerHTML = html;
      let inputs = Array.from(document.querySelectorAll('.quiz-cell-input'));
      inputs.forEach((input, idx)=>{
        input.onkeydown = function(e){
          if(e.key==='Enter'){
            let ans = input.dataset.answer.toLowerCase().trim();
            let val = input.value.toLowerCase().trim();
            let fb = input.nextElementSibling;
            let card = input.closest('.quiz-cell-ani');
            let kana = input.parentElement.querySelector('.quiz-cell-kana').textContent.trim().split(' ')[0];
            if(val === ans){
              fb.textContent = '✔ Correct!';
              fb.className = 'feedback correct';
              input.classList.add('correct'); input.classList.remove('incorrect');
              input.disabled = true;
              wrongSet.delete(kana);
              card.classList.remove('ani-wrong');
              card.classList.add('ani-correct');
            }else{
              fb.textContent = '✘ '+ans;
              fb.className = 'feedback incorrect';
              input.classList.add('incorrect'); input.classList.remove('correct');
              wrongSet.add(kana);
              card.classList.remove('ani-correct');
              card.classList.add('ani-wrong');
              input.focus();
            }
            setTimeout(()=>{
              card.classList.remove('ani-correct');
              card.classList.remove('ani-wrong');
            }, 510);
            setTimeout(()=>{
              if(idx+1 < inputs.length && !inputs[idx+1].disabled){
                inputs[idx+1].focus();
                inputs[idx+1].select();
              }
            }, 100);
          }
          if(e.key==='Tab'){
            e.preventDefault();
            if(idx+1 < inputs.length){
              inputs[idx+1].focus();
              inputs[idx+1].select();
            }
          }
        }
      });
      // 若全對則顯示鼓勵
      setTimeout(()=>{
        if(inputs.length>0 && inputs.every(inp=>inp.disabled)){
          let row = document.createElement('div');
          row.className = "score-float";
          row.innerHTML = '🎉 All correct! 太棒了！';
          document.getElementById('mainPanel').appendChild(row);
        }
      }, 400);
    }
    function renderQuizPaper(mode){
      let data = [];
      if(mode==='hiragana')data=HIRAGANA;
      else if(mode==='katakana')data=KATAKANA;
      else if(mode==='dakuten_hira')data=DAKUTEN_HIRA;
      else if(mode==='dakuten_kata')data=DAKUTEN_KATA;
      else if(mode==='handaku_hira')data=HANDAKU_HIRA;
      else if(mode==='handaku_kata')data=HANDAKU_KATA;
      else if(mode==='yoon')data=YOON;
      let pool = data.filter(x=>x&&x[0]);
      let qlist = pool.slice(0, Math.min(50, pool.length));
      let html = `<div class="quiz-paper"><div class="quiz-title">${{
        'hiragana':'平假名','katakana':'片假名','dakuten_hira':'濁音（平）','dakuten_kata':'濁音（片）','handaku_hira':'半濁音（平）','handaku_kata':'半濁音（片）','yoon':'拗音'
      }[mode]} Exam（${qlist.length}題 2分/題）</div><form id="examForm"><div class="jp-quiz-table">`;
      for(let i=0;i<qlist.length;i+=5){
        html += `<div class="jp-quiz-row">`;
        for(let j=0;j<5;j++){
          let idx = i+j;
          if(idx<qlist.length){
            let item = qlist[idx], n=idx+1;
            if(mode!=='yoon'){
              html += `<div class="quiz-cell"><div class="quiz-no">${n}</div>
                <div class="quiz-cell-kana">${item[0]}</div>
                <input class="quiz-a" name="q${idx}" data-answer="${item[1]}" autocomplete="off"></div>`;
            }else{
              html += `<div class="quiz-cell"><div class="quiz-no">${n}</div>
                <div class="quiz-cell-kana">${item[0]}<span class="jp-katakana">${item[1]}</span></div>
                <input class="quiz-a" name="q${idx}" data-answer="${item[2]}" autocomplete="off"></div>`;
            }
          }
        }
        html += `</div>`;
      }
      html += `</div><div style="text-align:center;margin-top:20px;"><button type="button" id="submitBtn" style="font-size:1.14em;font-weight:800;padding:10px 34px;background:#2266dd;color:#fff;border:none;border-radius:11px;box-shadow:0 2px 7px #2266dd32;cursor:pointer;">批改 Submit</button></div></form><div id="scoreBox"></div></div>`;
      document.getElementById('mainPanel').innerHTML = html;
      let inputs = Array.from(document.querySelectorAll('.quiz-a'));
      document.getElementById('submitBtn').onclick = function(){
        let total = qlist.length*2, score = 0, wrongs = [], wrongKana = [];
        inputs.forEach((input, idx)=>{
          let ans = input.dataset.answer.toLowerCase().trim();
          let val = input.value.toLowerCase().trim();
          if(val === ans){
            input.classList.add('correct'); input.classList.remove('incorrect');
            input.style.background = "";
            input.style.color = "";
            input.nextElementSibling?.remove();
            let ok = document.createElement('div');
            ok.className = 'ans-ok';
            ok.innerText = "✔";
            input.parentElement.appendChild(ok);
            wrongSet.delete(qlist[idx][0]);
          }else{
            input.classList.add('incorrect'); input.classList.remove('correct');
            input.style.background = "";
            input.style.color = "";
            input.nextElementSibling?.remove();
            let wa = document.createElement('div');
            wa.className = 'ans-wrong';
            wa.innerText = "✘ "+ans;
            input.parentElement.appendChild(wa);
            wrongSet.add(qlist[idx][0]);
            wrongs.push(idx);
            wrongKana.push(qlist[idx][0]);
          }
          if(val === ans) score+=2;
        });
        let percent = Math.round(score/total*100);
        let msg = `<div>你的分數：<b>${score} / ${total}</b>（${percent}分）</div>
          <div class="progress-ani"><div class="progress-bar" style="width:${percent}%"></div></div>
          <div class="score-float">${percent>=90?'👏 Very good!':'📈 Keep going!'}</div>`;
        if(wrongs.length){
          msg += `<div style="color:#ea5163;font-weight:700;">${wrongs.length} 題答錯，已自動加入「錯題複習」。<br>常錯：${wrongKana.join('、')}</div>`;
        }else{
          msg += `<div style="color:#22b77d;">全部正確，恭喜！</div>`;
        }
        document.getElementById('scoreBox').innerHTML = `<div class="score-box">${msg}</div>`;
      };
    }
    function updateView(){
      if(currType==='review') renderCards(currMode);
      else if(currType==='quiz') renderQuiz(currMode, false);
      else if(currType==='wrong') renderQuiz(currMode, true);
      else if(currType==='paper') renderQuizPaper(currMode);
    }
    document.getElementById('clearWrongBtn').onclick = function(){
      wrongSet.clear();
      alert('已清空錯題紀錄！');
      updateView();
    };
    const themeBtn = document.getElementById('themeBtn');
    const themeIcon = document.getElementById('themeIcon');
    themeBtn.onclick = () => {
      themeBtn.classList.add('switching');
      setTimeout(()=>themeBtn.classList.remove('switching'),420);
      if(document.documentElement.classList.contains('dark')){
        document.documentElement.classList.remove('dark');
        localStorage.setItem('theme','light');
        themeIcon.textContent = '🌗';
      }else{
        document.documentElement.classList.add('dark');
        localStorage.setItem('theme','dark');
        themeIcon.textContent = '☀️';
      }
    };
    (function(){
      let mode = localStorage.getItem('theme');
      if(mode==='dark'){document.documentElement.classList.add('dark');themeIcon.textContent='☀️';}
    })();
    // 首次載入
    updateView();
  </script>
</body>
</html>
